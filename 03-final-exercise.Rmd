# Hands on with `rsat`

We will use `rsat` for a simple task. In this example we will take a look at satellite images taken from La Palma island in the Canary Islands. The volcano of Cumbre Vieja erupted on the 19th of September of 2021, and continued until the 13th of December of the same year. Using satellite images we can observe the extent of the lava flow caused by the volcanic eruption, and check the evolution of the lava flow in the days following the initial eruption.

In order to start using the package we will need to load the library and set the credentials.

```{r eval=FALSE, echo=FALSE, message=FALSE}

library(rsat)

set_credentials("", "")


```

## Creating the `rtoi`

Now that the package is loaded and configured, the next step is to create the `rtoi`. First, we have to choose an area for the study we want to carry out, in our case the island of La Palma. We could use a shape file delimiting the area, but for this example we will use a quicker and easier approach. We can use the `mapview` and `mapedit` libraries to load an interactive map and select an area within the map. Please select the area corresponding the La Palma island with a polygon, it does not does not have to be exact, a rough outline is sufficient.

```{r eval=FALSE, echo=FALSE, message=FALSE}

library(mapview)
library(mapedit)
library(sf)

palma <- mapview() %>% editMap()

```

At this moment we have a variable called `palma` that contains the area we have selected as a `polygon` and a lot of metadata that does not interest us. `rsat` works with `sf` objects for defining the area of interest, this means that we have to extract the parameters that interests us from the variable and convert it to an `sf` object.

```{r eval=FALSE, echo=FALSE, message=FALSE}

palma <- st_as_sf(palma[[1]])

```

With the area as an `sf` object we can finally create the `rtoi` object. But before creating the `rtoi` we have to define a place to store it and the path to the *database* that will contain the downloaded files. For this example we already provide a *database* folder with the images to speed up the download process. Once those variables are defined we can proceed to the creation of the `rtoi`. At this moment we can give a name to the `rtoi`, this name will be used to create the folder that stores it and to load it at a latter date.

```{r eval=FALSE, echo=FALSE, message=FALSE}

rtoi.path <- file.path("")
db.path <- file.path("")

volcano <- new_rtoi("volcano",
                    palma,
                    rtoi.path,
                    db.path)

```

## Search using the `rtoi`

Once we have the `rtoi` created we can start the process of searching for images and filtering the ones that interest us in order to download them. We have mentioned previously that the eruption started on the 19th of September of 2021, so we can set the starting point of our time of interest a few days before that date, lets say the 10th of September. We will also extend the period of interest for 60 days.

The most basic search function, `rsat_search` takes 3 parameters: an `rtoi` object, a satellite product and a time period. For our example we will use Sentinel-2 images, so we will set the product to *S2MSI2A*.

```{r eval=FALSE, echo=FALSE, message=FALSE}

toi<-as.Date("2021-09-10")+0:60

rsat_search(volcano, "S2MSI2A", dates=toi)

```

## Filtering the `records` and downloading

We have created a set of `records` for our area and time of interest, but now we have to check which of those records we want to download. We can use the plot preview functionality for obtaining previews of the records to filter the ones that most interest us. When previewing we have to specify a `dates` variable with the dates we want to include in the preview, in order to better see the plotted previews it is better to use small subsets of the time of interest.

```{r eval=FALSE, echo=FALSE, message=FALSE}

plot(volcano, 
     "preview",
     tm.polygon.region.border.col="red",
     product="S2MSI2A",
     dates=toi[0:20])

```

Once we have chosen the dates to include in the study we can proceed to filter them in the `records` for the `rtoi`.

```{r eval=FALSE, echo=FALSE, message=FALSE}

rcds <- records(volcano)
dtes <- c(as.Date("2021-09-10"),
          as.Date("2021-09-15"),
          as.Date("2021-09-20"),
          as.Date("2021-09-25"),
          as.Date("2021-09-30"),
          as.Date("2021-10-05"),
          as.Date("2021-10-10"),
          as.Date("2021-10-15"))
rcds.f <- rcds[dates(rcds) %in% dtes]
records(volcano) <- rcds.f

```

```{r eval=FALSE, echo=FALSE, message=FALSE}

rsat_download(volcano)

```

```{r eval=FALSE, echo=FALSE, message=FALSE}

rsat_mosaic(volcano)

```

```{r eval=FALSE, echo=FALSE, message=FALSE}

plot(volcano, 
     "view",
     tm.polygon.region.border.col="red",
     product="S2MSI2A",
     dates=c(as.Date("2021-09-10"),as.Date("2021-09-30")))

```

## Deriving variables

```{r eval=FALSE, echo=FALSE, message=FALSE}

create histogram of the nir band to find threshold

```

```{r eval=FALSE, echo=FALSE, message=FALSE}

redModified = function(red, swir2){
  swir2[swir2<10000] = 0
  swir2 <- terra::stretch(swir2, 1, 4)
  out <- terra::stretch(red, 0, 255)
  return(out*swir2)
}
```

```{r eval=FALSE, echo=FALSE, message=FALSE}

rsat_derive(myRtoi, product = "S2MSI2A", variable = "redModified", fun = redModified)

```

Do not use the blue and green modified variables, load the bands from the rtoi get any band in rtoi list available data rsat_list_data(pamplona.derived) select band 1: MODIS_Grid_500m_2D_sur_refl_b01_1 mod.ndvi.rast \<- rsat_get_SpatRaster(pamplona.derived, "mod09ga", "MODIS_Grid_500m_2D_sur_refl_b01_1")

```{r eval=FALSE, echo=FALSE, message=FALSE}

red <- rsat_get_SpatRaster(myRtoi, "S2MSI2A", "redModified")
blue <- rsat_get_SpatRaster(myRtoi, "S2MSI2A", "blueModified")
green <- rsat_get_SpatRaster(myRtoi, "S2MSI2A", "greenModified")

```

```{r eval=FALSE, echo=FALSE, message=FALSE}

rgb<-c(red,green,blue)
plotRGB(stretch(rgb,0,255,minq=0, maxq=0.80))

```
